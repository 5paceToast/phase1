pkgname=linux
pkgver=5.4.10
pkgrel=2
pkgdesc="Linux kernel"
url="http://kernel.org"
#depends="mkinitfs"
_depends_dev="perl elfutils-dev bash flex bison"
makedepends="$_depends_dev gsed bc linux-dev openssl-dev"
options="!strip"
_config=${config:-config-vanilla.${CARCH}}
install=
source="https://cdn.kernel.org/pub/linux/kernel/v${pkgver%%.*}.x/linux-$pkgver.tar.xz
	config.aarch64
	config.x86_64
	config.riscv64
	"
subpackages="$pkgname-dev"

arch="all"
license="GPL-2.0"

_carch=${CARCH}
case "$_carch" in
aarch64*) _carch="arm64" ;;
mips*) _carch="mips" ;;
ppc*) _carch="powerpc" ;;
x86*) _carch="x86" ;;
riscv64*) _carch="riscv" ;;
*) error "Unsupported architecture" ;;
esac

prepare() {
	default_prepare
	mkdir -p ${srcdir}/build && cd ${srcdir}/build
	cp -v ${srcdir}/config.${CARCH} ${srcdir}/build/.config
	make -C ${srcdir}/linux-${pkgver} O=${srcdir}/build \
		ARCH="$_carch" HOSTCC="$CC" CC="$CC" AS=$AS HOSTAS=$AS HOSTLD=$LD LD=$LD \
		listnewconfig oldconfig
		
}

build() {
	cd ${srcdir}/build
	make -C ${srcdir}/linux-${pkgver} O=${srcdir}/build \
		ARCH="$_carch" HOSTCC="$CC" CC="$CC" AS=$AS HOSTAS=$AS HOSTLD=$LD LD=$LD \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-abyss"
}

package() {
	cd ${srcdir}/build
	mkdir -p ${pkgdir}/boot ${pkgdir}/lib/modules

	case "$CARCH" in
		arm*)
			mkdir -p ${pkgdir}/boot/dtb
			for i in arch/arm/boot/dts/*.dtb; do
				install -m644 "$i" ${pkgdir}/boot/dtb/
			done
			;;
		*)
			;;
	esac

	# modules are disabled at the moment
#	make ARCH="$_carch" HOSTCC="$CC" CC="$CC" AS=$AS HOSTAS=$AS HOSTLD=$LD LD=$LD \
#		INSTALL_MOD_PATH="$pkgdir/usr" INSTALL_PATH="$pkgdir/boot" INSTALL_HDR_PATH="$pkgdir/usr" install modules_install headers_install
	make ARCH="$_carch" HOSTCC="$CC" CC="$CC" AS=$AS HOSTAS=$AS HOSTLD=$LD LD=$LD \
		INSTALL_MOD_PATH="$pkgdir/usr" INSTALL_PATH="$pkgdir/boot" INSTALL_HDR_PATH="$pkgdir/usr" install headers_install

	mkdir -p ${pkgdir}/usr
	mv -v ${pkgdir}/lib ${pkgdir}/usr/
}

b2sums="88706cfc05ec1cc201f08e069dc6ad4f8e6fb49dbef5937208ba1e752e18b46639a5d32d4d0e270a0f2f6ed872aed70beeb2b0367d41fe443437331902a90bb2  linux-5.4.10.tar.xz
f4ced3fbc0b7f68d268b808e669a8c2ab161f4bf0597f66eecacb4d7537faab8ce42df3456ec3eed1520674c381b67e136fa90cc4971b12cd801e72cffde1ded  config.aarch64
7c8d760112b6b878ebbc9a6a4981f8f66b4a9f652b3f75cb8177c00a8ea7c3dc08af86179915d9a03bf835a23dcff42e286f2f3656a65f21e5c729992facf6bb  config.x86_64
d7c54880b8af226309cbcd2492ab2f2f3dd8b8facf9caad4eb7c097e7ff8c9c3c88802f65d7f5c738b3d173fe550a6662a56c68a024107ded1a8fcf11a17a572  config.riscv64"
