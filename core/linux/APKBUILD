pkgname=linux
pkgver=5.6.2
pkgrel=0
pkgdesc="Linux kernel"
url="http://kernel.org"
#depends="mkinitfs"
makedepends="perl elfutils-dev bash flex bison gsed bc linux-dev openssl-dev binutils rsync findutils"
options="!strip"
_config=${config:-config-vanilla.${CARCH}}
install=
source="https://cdn.kernel.org/pub/linux/kernel/v${pkgver%%.*}.x/linux-$pkgver.tar.xz
	config.aarch64
	config.x86_64
	config.riscv64
	config.mips64
	restore_octeon_staging.patch
	"
subpackages="$pkgname-dev"

arch="all"
license="GPL-2.0"

export AS=gnu-as LD=gnu-ld

_carch=${CARCH}
case "$_carch" in
aarch64*) _carch="arm64" ;;
mips*) _carch="mips" ;;
ppc*) _carch="powerpc" ;;
x86*) _carch="x86" ;;
riscv64*) _carch="riscv" ;;
*) error "Unsupported architecture" ;;
esac

prepare() {
	default_prepare
	mkdir -p ${srcdir}/build && cd ${srcdir}/build
	cp -v ${srcdir}/config.${CARCH} ${srcdir}/build/.config
	# sledgehammer, update build env
	export OTC="$(toolchain show)"
	msg "Updating buildenv (currently: ${OTC})..."
	toolchain none gnu
	make -C ${srcdir}/linux-${pkgver} O=${srcdir}/build \
		ARCH="$_carch" HOSTCC="$CC" CC="$CC" AS=$AS HOSTAS=$AS HOSTLD=$LD LD=$LD \
		listnewconfig oldconfig
}

build() {
	cd ${srcdir}/build
	make -C ${srcdir}/linux-${pkgver} O=${srcdir}/build \
		ARCH="$_carch" HOSTCC="$CC" CC="$CC" AS=$AS HOSTAS=$AS HOSTLD=$LD LD=$LD \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-abyss"
	msg "Reverting buildenv (${OTC})..."
	toolchain ${OTC}
}

package() {
	cd ${srcdir}/build
	mkdir -p ${pkgdir}/boot ${pkgdir}/lib/modules

	case "$CARCH" in
		arm*)
			mkdir -p ${pkgdir}/boot/dtb
			for i in arch/arm/boot/dts/*.dtb; do
				install -m644 "$i" ${pkgdir}/boot/dtb/
			done
			;;
		*)
			;;
	esac

	# modules are disabled at the moment
#	make ARCH="$_carch" HOSTCC="$CC" CC="$CC" AS=$AS HOSTAS=$AS HOSTLD=$LD LD=$LD \
#		INSTALL_MOD_PATH="$pkgdir/usr" INSTALL_PATH="$pkgdir/boot" INSTALL_HDR_PATH="$pkgdir/usr" install modules_install headers_install
	make ARCH="$_carch" HOSTCC="$CC" CC="$CC" AS=$AS HOSTAS=$AS HOSTLD=$LD LD=$LD \
		INSTALL_MOD_PATH="$pkgdir/usr" INSTALL_PATH="$pkgdir/boot" INSTALL_HDR_PATH="$pkgdir/usr" install headers_install

	mkdir -p ${pkgdir}/usr
	mv -v ${pkgdir}/lib ${pkgdir}/usr/
}

b2sums="c5b250e64c2753b5525b8612933864e4fe81befb482e1696696844a7ec40b4c3a1ce7a79cc5277bf215b88fec470f84db922494a917e7c566928d2721d0b17c3  linux-5.6.2.tar.xz
f4ced3fbc0b7f68d268b808e669a8c2ab161f4bf0597f66eecacb4d7537faab8ce42df3456ec3eed1520674c381b67e136fa90cc4971b12cd801e72cffde1ded  config.aarch64
7fb0a9851a85eeb97880c2656e9f898a2758fb0a2ff0939d4c39db6382f778077a66a3998c54cc2d008294f5499394fc32c2e7bc29b3625c5349ebd4a8132a14  config.x86_64
d7c54880b8af226309cbcd2492ab2f2f3dd8b8facf9caad4eb7c097e7ff8c9c3c88802f65d7f5c738b3d173fe550a6662a56c68a024107ded1a8fcf11a17a572  config.riscv64
9ccaf9ecd92f92101b20fbc96a451db49077dee1de90abe9e374d21c016b9eb26380227d310d61992bfc5203080050769a88225610cac095eda66e71c0495468  config.mips64
d297f1d6f64aecd6665750d59f902ee85ffc4c75a547413e64bd544dcb7720cf37f82abc89685ee8b1f21e4fdec77e17a58427bc784104dbfbdec495c8d46a86  restore_octeon_staging.patch"
