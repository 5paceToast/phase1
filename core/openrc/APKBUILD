pkgname=openrc
pkgver=0.42.1
_ver=${pkgver/_git*/}
pkgrel=0
pkgdesc="OpenRC manages the services, startup and shutdown of a host"
url="https://github.com/OpenRC/openrc"
arch="all"
license="BSD-2-Clause"
provides=init
makedepends="bsd-compat-headers"
subpackages="$pkgname-doc $pkgname-dev
	$pkgname-zsh-completion:zshcomp:noarch
	$pkgname-bash-completion:bashcomp:noarch"
install="$pkgname.post-install $pkgname.post-upgrade"
source="$pkgname-$pkgver.tar.gz::https://github.com/OpenRC/openrc/archive/$pkgver.tar.gz

	0001-call-sbin-mkmntdirs-in-localmount-OpenRC-service.patch
	0002-force-root-be-rw-before-localmount.patch
	0003-sysctl-add-compatibility-for-busybox-sysctl.patch
	0004-hide-error-when-migrating-var-run-to-run.patch
	0005-rc-pull-in-sysinit-and-boot-as-stacked-levels-when-n.patch
	0007-make-consolefont-service-compatible-with-busyboxs-se.patch
	0001-fsck-don-t-add-C0-to-busybox-fsck.patch
	0008-fix-undeclared-UT_LINESIZE.patch
	0009-Support-early-loading-of-keymap-if-kdb-is-installed.patch

	openrc.logrotate
	hostname.initd
	hwdrivers.initd
	modules.initd
	modloop.initd
	modloop.confd
	sysfsconf.initd
	firstboot.initd
	"

prepare() {
	default_prepare
	sed -i -e '/^sed/d' "$builddir"/pkgconfig/Makefile
}

build() {
	cd "$builddir"

	export MKZSHCOMP=yes
	export MKBASHCOMP=yes
	make LIBEXECDIR=/usr/lib/rc
}

package() {
	local i j

	cd "$builddir"
	make LIBEXECDIR=/usr/lib/rc DESTDIR="$pkgdir/" install

	# we cannot have anything turned on by default
	rm -f "$pkgdir"/etc/runlevels/*/*

	# we override some of the scripts
	for i in "$srcdir"/*.initd; do
		j=${i##*/}
		install -Dm755 $i "$pkgdir"/etc/init.d/${j%.initd}
	done

	# we override some of the conf.d files
	for i in "$srcdir"/*.confd; do
		j=${i##*/}
		install -Dm644 $i "$pkgdir"/etc/conf.d/${j%.confd}
	done

	# additional documentation considered useful
	mkdir -p "$pkgdir"/usr/share/doc/$pkgname/
	install -m644 ChangeLog *.md "$pkgdir"/usr/share/doc/$pkgname/

	# we use a virtual keymaps services to allow users to set their
	# keymaps either with the OpenRC loadkeys service provided by
	# the kbd aport or with the loadkmap service provided by the
	# busybox-initscripts aport.
	rm -f "$pkgdir/etc/init.d/keymaps" \
		"$pkgdir/etc/conf.d/keymaps"

	install -Dm644 "$srcdir/$pkgname.logrotate" "$pkgdir/etc/logrotate.d/$pkgname"
	install -d "$pkgdir"/etc/local.d "$pkgdir"/run

	mkdir -p $pkgdir/usr/bin
	mv -v $pkgdir/sbin/* $pkgdir/usr/bin/
	rm -rfv $pkgdir/sbin

	mv -v $pkgdir/bin/* $pkgdir/usr/bin/
	rm -rfv $pkgdir/bin

	mkdir -p $pkgdir/usr/lib
	mv -v $pkgdir/lib/* $pkgdir/usr/lib/
	rm -rfv $pkgdir/lib

	# openrc upstream removed service(8) for whatever reason, put it back
	#ln -s /sbin/rc-service "$pkgdir"/usr/bin/service
}

bashcomp() {
	depends=""
	pkgdesc="Bash completions for $pkgname"
	install_if="$pkgname=$pkgver-r$pkgrel bash-completion"

	mkdir -p "$subpkgdir"/usr/share/bash-completion
	mv "$pkgdir"/usr/share/bash-completion/completions \
		"$subpkgdir"/usr/share/bash-completion
	rm -rf "$pkgdir"/usr/share/bash-completion
}

zshcomp() {
	depends=""
	pkgdesc="Zsh completions for $pkgname"
	install_if="$pkgname=$pkgver-r$pkgrel zsh"

	mkdir -p "$subpkgdir"/usr/share/zsh
	mv "$pkgdir"/usr/share/zsh/site-functions \
		"$subpkgdir"/usr/share/zsh
	rm -rf "$pkgdir"/usr/share/zsh
}

sha512sums="579b9bfbb151b945a364a2c12b037d2e15991820ca99a07ac18e9bdc50074e67fbf0dcf9865aa4deabe2bf82092e4623be51c9e0b4014384951e0a92ac1e7646  openrc-0.42.1.tar.gz
671f42e7687e0072c7a88627a6015a61a1e340d571711440c78a4d52f7459d423496bc4471ad23aaa6624f33717167197a534467323b4ffc6fee552ceee119c1  0001-call-sbin-mkmntdirs-in-localmount-OpenRC-service.patch
b1cedd38badda4fc308decdff06f9644b96fe35617792da8d6d62407409841705fd71b5b57d1804a6395095604a70898f80830c76395ec99f715038a0809d815  0002-force-root-be-rw-before-localmount.patch
9dea3fcdb90e3e8078a771beefeba3ca91b9966a1b8ee9ff96cf460e7dd21abbc4a46a501a960c3edf5a76c083c2cf60ccb06d9da7a4c6df2a50660745beb278  0003-sysctl-add-compatibility-for-busybox-sysctl.patch
d54630d40a2d6b10a325cb012d4efcda997a60c008ca953ce5d60059d3f267308a59dabddf93a5fc0d301aa91967137d144effbe5f574394af768ce4ebc48738  0004-hide-error-when-migrating-var-run-to-run.patch
39a35c54ec9112fe84c901ed155a711cec8e194af02d5483ee60b80743dab12391e6fdc7b3da2f86844dd4edcf53e681ff95bd4d6fa1101a89ce54dce2ddbb7c  0005-rc-pull-in-sysinit-and-boot-as-stacked-levels-when-n.patch
234c4f3cf39df3350dbea25c00b8d584794b28194f44c726767a6a16d91a26fee1b5d2dd16635f19803fc015b4e9d99c52b23128e6b815938b88365feba8cf59  0007-make-consolefont-service-compatible-with-busyboxs-se.patch
dbe3f170440f0f357f31ac4d49c56a9a7ec22172df2701bf4a0afdee22aedda1f88b9fa5ffdbe19a5eea3c764ad0e4c802e19b95b7082a72d423d46d30c18edd  0001-fsck-don-t-add-C0-to-busybox-fsck.patch
d2b8700f56b05579926352855de8fcee5cf78f0c13200643a5195f8c60e2b5082d476b42cc77b13246b9fb883aa002d723237b0fc7ae84ccd7ebe3b25690cf50  0008-fix-undeclared-UT_LINESIZE.patch
667085d89e194f7e2255d5c098c3d8de272f54cb925710cb98d5e7a6b58982d0acfe15f97b574cfc646b139cd7aa5b527ba700ef9b8048a6d6d9dee8cc74913c  0009-Support-early-loading-of-keymap-if-kdb-is-installed.patch
12bb6354e808fbf47bbab963de55ee7901738b4a912659982c57ef2777fff9a670e867fcb8ec316a76b151032c92dc89a950d7d1d835ef53f753a8f3b41d2cec  openrc.logrotate
259552165ee5e9ca973bbe18d1d9ec5cc67526cb26a9e0ac717076ef4913bb7ff4055d6ccb9f77996ed9c00b67f46edba552e1a21b836068a112dda2428502b3  hostname.initd
c06eac7264f6cc6888563feeae5ca745aae538323077903de1b19102e4f16baa34c18b8c27af5dd5423e7670834e2261e9aa55f2b1ec8d8fdc2be105fe894d55  hwdrivers.initd
b04058ec630e19de0bafefe06198dc1bff8c8d5d2c89e4660dd83dda8bb82a76cdb1d8661cce88e4a406aa6b4152e17efff52d3eb18ffaec0751d0b6cdbcc48a  modules.initd
595098085d5a1204e3c5af59bb4a3b3d1fb2980db77925995aa1ec43ef5ae378cef736ddc7924191a99d39c93891d59274fbba08127b15d584c2f82b067ef683  modloop.initd
80e43ded522e2d48b876131c7c9997debd43f3790e0985801a8c1dd60bc6e09f625b35a127bf225eb45a65eec7808a50d1c08a5e8abceafc61726211e061e0a2  modloop.confd
d76c75c58e6f4b0801edac4e081b725ef3d50a9a8c9bbb5692bf4d0f804af7d383bf71a73d5d03ed348a89741ef0b2427eb6a7cbf5a9b9ff60a240639fa6ec88  sysfsconf.initd
f65b061b4272463071022e88a7392d5573f2d95f91e42c8b4f3ef69171604460ddd3d426dfbab382f73a3fac68d4b4ff3a923fdc49fb6fd9f27ebd3ab24e0d0e  firstboot.initd"
b2sums="381f52552c13afbbcf45456fe71078bacf9182adfd67c97394093986977f5e8262d8a3c64219501745575a5210f525afe9fccee72f7625485a9f575108baa369  openrc-0.42.1.tar.gz
e7075cc2859d49c99d61c9ff9831ebd068f36dc83ff29de022be547cf834c459269e9d8b9423b552751178597b7cbb42e6b9bad367784ae6f8248b34ad899ae8  0001-call-sbin-mkmntdirs-in-localmount-OpenRC-service.patch
6a65e97045b3166c34fe0235fd8c3ba8dfaa3df7f592043361be7289b0abb7cabf535078be13d8d06da8c71475a07b8442fe9f5a9a56afa2b77ee1469f1957bd  0002-force-root-be-rw-before-localmount.patch
e07e698893cefc14273a1775e999a2cd62bbd24d7fa0069a0d3576670874ac14729a8d5c0ae4afa41ab09e04192840bea46086caad322dce1d33dbeb426ce478  0003-sysctl-add-compatibility-for-busybox-sysctl.patch
bdc3a3510c7863612738ebb998e1dfa391e1f6f99281e988be800939cc823dc883628fab9bf35d3983c78357c9ee80c5828764c0fb748a68cb038235e3cd451d  0004-hide-error-when-migrating-var-run-to-run.patch
64abb9fd6e7941ecf4d803c85bd20e96ef8327db6d9e2b74ff5fae43dfcbdd6297c435f36e4663126aadc8d8fa1fb7fed0e12fc7f59441b1956734ad7ffd6809  0005-rc-pull-in-sysinit-and-boot-as-stacked-levels-when-n.patch
4eba9a118f0991a6ec02c4adc75bd738c4aefb45252243b505898950fe1b9a2ec5219dba3c28ea619d005dc46c0243b21e2ab05f9dd6299158c33d7200ffc95c  0007-make-consolefont-service-compatible-with-busyboxs-se.patch
d7d962126241030f2b461f920d1ffaccf0803d5acf5879848c233c3d8f1e44c9efc6f4bd93101ec7dcc6e3d7bffa53ca8bd711c60d8dfa95b5743f7e75262524  0001-fsck-don-t-add-C0-to-busybox-fsck.patch
3299a71a3aca7008994da607307b01a16f00024b4288a6ec6caa7f30e96786f8d29732c922f81cf617cfb95523c5fe2cd89cea4f4830ad46ede83ba357e2579a  0008-fix-undeclared-UT_LINESIZE.patch
349f48404d0f6ec5a3f5caa1461c51a04771020cd14e6c78ed6b0b9710a7ec5777a71e2a611b2bd474f837c57e68071d30eefae5df6145b3c5fdfcc6b66f187e  0009-Support-early-loading-of-keymap-if-kdb-is-installed.patch
0587cd211767937fd6273e6b159271490443a94d80a54b5a20ef625a1959e77dbf38cd1756838337fb39a061c4ee19a39cccd2f5867fab9f04fb916a74029aaa  openrc.logrotate
39605d9e8967b1d9e097d5ddd1dc823d7671f6386dfa7fdbd88ef3524e944aa04775e72f7c42d98d866fd106e61c3911e749495b7a5d0e91cb87e3860b1eace8  hostname.initd
bb8278e71b90dd1e94a2ecc01bda05f269b651eb9adeda76be9587344b32c904a4793939b37f43c50d851547bba79088e923241fe4f92e8ad8a37b182fb0c6cb  hwdrivers.initd
16528ea8d939010b256904a22d60cb8f2ad23ac88d32ce95aa72cb0008132aac1127b0650f3484c91af2df9aa06744185288405314c6349c07fe5c5c03b72d13  modules.initd
f3b284371618dbcc6d4d3916604a058f7bc25c7a29c094347da69c0a93e8dee1ff2642178efc7b613add1b904d2a638f07a141fe22f33f9bc92c2b5f3be35afb  modloop.initd
7d32ffc9d394ac96a67b3f6956e98fa1426ed02f46d889627608ac3d937a6bf04059af9df62c720f1f1caf2b1060457ae296b2536d240fca6b5e9b8bf40bb12f  modloop.confd
514a6813f004642b2a33d9f15baef1210e394082289de652842aedf73aeba3bf8de467449f2483d2a0606572a1797299bbf3cf6967ce78a02cdd1414fc4ceeef  sysfsconf.initd
3cda7aa9ff575962e87d0fdc69cce2354b99a41568bb6bc97eede352bbf13083fda7a1584eddbcaee906529e2590bbbdfb57c778c34e70e339d16fdd57555144  firstboot.initd"
