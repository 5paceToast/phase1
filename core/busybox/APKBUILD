pkgname=busybox
pkgver=1.31.1
pkgrel=8
pkgdesc="Size optimized toolbox of many common UNIX utilities"
url="https://busybox.net/"
arch="all"
license="GPL-2.0"
makedepends="linux-dev bash"
checkdepends="zip"
# Needs which(1), enabled in busybox-1.31.1-r1
options=""
#subpackages="$pkgname-aalt"
triggers="busybox.trigger=/usr/bin"
provides="/bin/sh"
source="https://busybox.net/downloads/$pkgname-$pkgver.tar.bz2
	busyboxconfig
	clang.patch
	0013-testsuite-fix-cpio-tests.patch
	"

builddir="$srcdir"/$pkgname-$pkgver

prepare() {
	default_prepare

	# Fails in containers (lack of permission)
	rm "$builddir"/testsuite/mdev.tests

	cp -v $srcdir/busyboxconfig .config
}

build() {
	make
}

check() {
	SKIP_KNOWN_BUGS=1 make V=1 check
}

package() {
	mkdir -p $pkgdir/usr/bin
	install -m755 $builddir/busybox "$pkgdir"/usr/bin/busybox
}

aalt() {
	depends="$depends aalt"
	pkgdesc="$pkgdesc (AAlt registration files)"
	install_if="aalt ${subpkgname%-aalt}=$pkgver-r$pkgrel"

	for a in $("$pkgdir"/usr/bin/busybox --list)
	do
		DESTDIR="$subpkgdir" aalt-bin -R -g busybox -p "$a" -f /usr/bin/busybox
	done
}

b2sums="95c2345bc715eb7a1f08816a40add9b7a6176ef509a84069343ec2caddec58d8d57a07676ca2b03c209734169321433e27ba963b4c8b98dbfda4e409dcc347b4  busybox-1.31.1.tar.bz2
4c9aba1ded29814fb71114368f3d6a47f34c4a1da9c357d3afb8bd28fc5b793464f4d01218644ebbd61d79832ec1053c6043bc6f769b094e8a636b690b7d05f7  busyboxconfig
60a1b7f1e26f91587c81b3aa147aafc6a6c13c4bc0e7565851ee70081b5867895c5bc9c9cfe42dab4cb41cfa588272be0a20d86ba6423ea18d6e78b458f37426  clang.patch
82b65d12ea93fb86b78e6d61fab658fc019dd895c8fde4739a03a7ef045b529801054b9e3449646aef4e3deea45c6c9c8ac679bc3355620fed857a9941a9a48a  0013-testsuite-fix-cpio-tests.patch"
