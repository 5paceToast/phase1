pkgname=gsed
pkgver=4.7
pkgrel=1
subpackages="$pkgname-doc"
pkgdesc="GNU stream editor"
url="https://www.gnu.org/software/sed"
arch="all"
license="GPL-3.0+"
makedepends="perl"
checkdepends="diffutils"
install="$pkgname.post-deinstall"
source="https://ftp.heanet.ie/mirrors/ftp.gnu.org/gnu/sed/sed-$pkgver.tar.xz
	disable-mbrtowc-test.patch
	busybox-timeout-test.patch
	"
options="!checkroot"
builddir="$srcdir/sed-$pkgver"

prepare() {
	default_prepare

	# Relies on unwrittable directory, which needs non-root
	sed -i 's/testsuite\/panic-tests.sh//' Makefile.in
}

build() {
	cd "$builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--disable-i18n \
		--disable-nls \
		--program-prefix=g
	make
}

check() {
	cd "$builddir"
	make check
}

package() {
	cd "$builddir"
	make DESTDIR="$pkgdir" install

	rm -rf "$pkgdir"/usr/lib/charset.alias || true
	rmdir -p "$pkgdir"/usr/lib 2>/dev/null || true
}

b2sums="752bc2e942b6f041710c6811518147c5fa4b143b33ae842ec1f142ec914bfaf4d7e8a94a2b1a5b345789944e5426f7946997f2ccbc43ee5034351a95ce3a677e  sed-4.7.tar.xz
fd6348778f065c19a3ddb2184ead06bcff47fc49f83bce052fc413616d9881525652e201265ae56618cfe6b8bb4a4f80c1ba31a249a1e28513830aaad209b925  disable-mbrtowc-test.patch
8d0d420fea4f635854d20b70fd94d43bcb0dd5cdeabb4a7e3c33dcf60829520f2e302292488bffd6e8fc04b1a0b04ba585f301798880f006cba8fd776996aa72  busybox-timeout-test.patch"
