# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=automake
pkgver=1.16.1
pkgrel=0
pkgdesc="A GNU tool for automatically creating Makefiles"
url="https://www.gnu.org/software/automake"
arch="noarch"
license="GPL-2.0-or-later MIT Public-Domain"
depends="perl"
makedepends="autoconf"
checkdepends_opt="libtool flex gettext" # compress expect emacs rst2html
checkdepends="bash $checkdepends_opt"
subpackages="$pkgname-doc"
source="https://ftp.gnu.org/gnu/$pkgname/$pkgname-$pkgver.tar.gz"

prepare() {
	cd "$builddir"

	# Test were `python` is assumed to be Python2
	sed -i \
		-e '/^t\/nobase-python.sh \\$/d' \
		-e '/^t\/py-compile-basic.sh \\$/d' \
		-e '/^t\/py-compile-basedir.sh \\$/d' \
		-e '/^t\/py-compile-destdir.sh \\$/d' \
		-e '/^t\/py-compile-option-terminate.sh \\$/d' \
		-e '/^t\/python3.sh \\$/d' \
		-e '/^t\/python10.sh \\$/d' \
		-e '/^t\/python12.sh \\$/d' \
		Makefile.in

	# Supposed to detect GNU make but fails
	sed -i '/^t\/self-check-shell-no-trail-bslash.sh \\/d' Makefile.in

	# strip: error: unknown argument '--verbose'
	sed -i \
		-e '/^t\/strip2.sh \\/d' \
		-e '/^t\/strip3.sh \\/d' \
		Makefile.in

	# failing weird sub-testsuite
	sed -i \
		-e '/^t\/tap-numbers-leading-zero.sh \\$/d' \
		-e '/^t\/tap-plan-leading-zero.sh \\$/d' \
		Makefile.in

	default_prepare
}

build() {
	cd "$builddir"
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--bindir=/usr/bin \
		--sbindir=/usr/bin
	make
}

check() {
	cd "$builddir"
	make check
}

package() {
	cd "$builddir"
	make DESTDIR=$pkgdir install
}

sha512sums="47b0120a59e3e020529a6ce750297d7de1156fd2be38db5d101e50120f11b40c28741ecd5eacf2790a9e25386713dcf7717339cfa5d7943d0dbf47c417383448  automake-1.16.1.tar.gz"
