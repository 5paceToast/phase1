pkgname=clang
subpackages="$pkgname-dev $pkgname-aalt"

. ../llvm/common.inc

source="https://github.com/llvm/llvm-project/releases/download/llvmorg-$pkgver/$pkgname-$pkgver.src.tar.xz
	mips_softfloat.patch"

builddir="$srcdir/$pkgname-$pkgver.src"
_builddir="$srcdir/build"

depends="compiler-rt libcxx llvm"
makedepends="aalt cmake lld llvm-dev"

prepare() {
	default_prepare
	mkdir -p $_builddir && cd $_builddir

	cmake -G Ninja -Wno-dev \
			-DCMAKE_C_COMPILER=$CC \
			-DCMAKE_CXX_COMPILER=$CXX \
			-DCMAKE_C_COMPILER_TARGET=$CTARGET \
			-DCMAKE_CXX_COMPILER_TARGET=$CTARGET \
			-DCMAKE_C_FLAGS="$CFLAGS" \
			-DCMAKE_CXX_FLAGS="$CXXFLAGS" \
			-DCMAKE_INSTALL_PREFIX=/usr \
			-DCMAKE_BUILD_TYPE=Release \
			-DCLANG_DEFAULT_LINKER=$_linker \
			-DCLANG_DEFAULT_CXX_STDLIB='libc++' \
			-DCLANG_DEFAULT_RTLIB=compiler-rt \
			-DCLANG_DEFAULT_UNWINDLIB=libunwind \
			-DCLANG_VENDOR="Abyss OS" \
			-DCLANG_ENABLE_STATIC_ANALYZER=OFF \
			-DCLANG_ENABLE_ARCMT=OFF \
			$builddir
}

build() {
	cd $_builddir
	ninja -j${JOBS}
}

package() {
	cd $_builddir
	DESTDIR="$pkgdir" ninja install
}

aalt() {
    depends="$depends aalt"
    pkgdesc="$pkgdesc (AAlt registration files)"
    install_if="aalt ${subpkgname%-aalt}=$pkgver-r$pkgrel"

    for p in as cc c++ cpp
    do
        DESTDIR="$subpkgdir" aalt-bin -R -g llvm -p $p -f /usr/bin/clang
    done
}

b2sums="fc03cc9f86891f341ca4cc185788555c11674a87956f14f6b0efc97d8562a5472242c8b94e46876bb96151214b287a4d3b1e8db1dd124468fdec4af0f75e94c9  clang-9.0.1.src.tar.xz
e7fe4f6e3f3afab357bf3c781a8e52ee228f2174b80e7113fb75d5aaefedb87e2067b53ab3f21049e4c3dda6571b0b75b075d563d2e598cbc896299039ebab7b  mips_softfloat.patch"
